package BD;

import javax.swing.*;
import javax.swing.border.LineBorder;
import java.awt.*;
import java.security.MessageDigest;
import java.util.Base64;

public class Registro {

    public JFrame frame;
    private JTextField txtUsername;
    private JPasswordField txtPassword;
    private JTextField txtNombre;

    private final Color SIDEBAR_COLOR = new Color(30, 41, 59);
    private final Color PRIMARY_COLOR = new Color(59, 130, 246);
    private final Color BG_COLOR = new Color(241, 245, 249);
    private final Color CARD_COLOR = Color.WHITE;
    private final Color TEXT_DARK = new Color(30, 41, 59);

    public Registro() {
        initialize();
    }

    private void initialize() {

        frame = new JFrame();
        frame.setUndecorated(true);
        frame.setSize(488, 552);
        frame.setDefaultCloseOperation(JFrame.DISPOSE_ON_CLOSE);
        frame.setLocationRelativeTo(null);
        frame.getContentPane().setLayout(null);
        frame.getContentPane().setBackground(BG_COLOR);

        JButton btnCerrar = new JButton("X");
        btnCerrar.setBounds(448, 5, 35, 25);
        btnCerrar.setFont(new Font("Segoe UI", Font.BOLD, 14));
        btnCerrar.setBackground(new Color(239, 68, 68));
        btnCerrar.setForeground(Color.WHITE);
        btnCerrar.setBorder(null);
        btnCerrar.setFocusPainted(false);
        btnCerrar.addActionListener(e -> volverAlLogin());
        frame.getContentPane().add(btnCerrar);

        JPanel panelFondo = new JPanel(null);
        panelFondo.setBackground(SIDEBAR_COLOR);
        panelFondo.setBounds(0, 0, 488, 552);
        frame.getContentPane().add(panelFondo);

        JPanel tarjeta = new JPanel(null);
        tarjeta.setBackground(CARD_COLOR);
        tarjeta.setBounds(60, 20, 360, 498);
        tarjeta.setBorder(new RoundBorder(25));
        panelFondo.add(tarjeta);

        JLabel lblTitulo = new JLabel("REGISTRO", SwingConstants.CENTER);
        lblTitulo.setFont(new Font("Segoe UI", Font.BOLD, 26));
        lblTitulo.setForeground(PRIMARY_COLOR);
        lblTitulo.setBounds(50, 20, 260, 40);
        tarjeta.add(lblTitulo);

        JLabel lblNombre = new JLabel("Nombre");
        lblNombre.setFont(new Font("Segoe UI", Font.PLAIN, 15));
        lblNombre.setForeground(TEXT_DARK);
        lblNombre.setBounds(40, 90, 200, 20);
        tarjeta.add(lblNombre);

        txtNombre = new JTextField();
        txtNombre.setBounds(40, 115, 280, 40);
        txtNombre.setBorder(new RoundBorder(20));
        tarjeta.add(txtNombre);

        JLabel lblUsuario = new JLabel("Usuario");
        lblUsuario.setFont(new Font("Segoe UI", Font.PLAIN, 15));
        lblUsuario.setForeground(TEXT_DARK);
        lblUsuario.setBounds(40, 165, 200, 20);
        tarjeta.add(lblUsuario);

        txtUsername = new JTextField();
        txtUsername.setBounds(40, 190, 280, 40);
        txtUsername.setBorder(new RoundBorder(20));
        tarjeta.add(txtUsername);

        JLabel lblPass = new JLabel("Contrase√±a");
        lblPass.setFont(new Font("Segoe UI", Font.PLAIN, 15));
        lblPass.setForeground(TEXT_DARK);
        lblPass.setBounds(40, 240, 200, 20);
        tarjeta.add(lblPass);

        txtPassword = new JPasswordField();
        txtPassword.setBounds(40, 265, 280, 40);
        txtPassword.setBorder(new RoundBorder(20));
        tarjeta.add(txtPassword);

        JButton btnRegistrar = new JButton("Registrar");
        btnRegistrar.setFont(new Font("Segoe UI", Font.BOLD, 16));
        btnRegistrar.setBounds(90, 340, 180, 45);
        btnRegistrar.setBackground(PRIMARY_COLOR);
        btnRegistrar.setForeground(Color.WHITE);
        btnRegistrar.setBorder(new RoundBorder(25));
        btnRegistrar.setFocusPainted(false);
        btnRegistrar.addActionListener(e -> registrar());
        tarjeta.add(btnRegistrar);
    }

    // -----------------------------
    // REGISTRAR USUARIO Y VOLVER AL LOGIN
    // -----------------------------
    private void registrar() {
        String user = txtUsername.getText().trim();
        String pass = new String(txtPassword.getPassword()).trim();
        String nombre = txtNombre.getText().trim();

        if (user.isEmpty() || pass.isEmpty() || nombre.isEmpty()) {
            JOptionPane.showMessageDialog(frame, "Llena todos los campos");
            return;
        }

        // Verificar usuario existente
        for (Usuario u : Loginn.usuariosEnMemoria) {
            if (u.getUsuario().equals(user)) {
                JOptionPane.showMessageDialog(frame, "Ese usuario ya existe");
                return;
            }
        }

        // Encriptar contrase√±a
        String passEncriptada = encryptPassword(pass);

        // Guardar en memoria
        Usuario nuevo = new Usuario(user, passEncriptada, nombre);
        Loginn.usuariosEnMemoria.add(nuevo);

        JOptionPane.showMessageDialog(frame,
                "‚úÖ Usuario registrado correctamente\nAhora puedes iniciar sesi√≥n");

        volverAlLogin();
    }

    // üîÅ Volver al Login
    private void volverAlLogin() {
        Loginn login = new Loginn();
        login.frmLogin.setVisible(true);
        frame.dispose();
    }

    // üîê Encriptar contrase√±a
    public static String encryptPassword(String password) {
        try {
            MessageDigest md = MessageDigest.getInstance("SHA-256");
            return Base64.getEncoder().encodeToString(md.digest(password.getBytes("UTF-8")));
        } catch (Exception e) {
            return null;
        }
    }

    // üî≤ Borde redondeado
    class RoundBorder extends LineBorder {
        private int radius;

        public RoundBorder(int radius) {
            super(new Color(220, 220, 220), 1, true);
            this.radius = radius;
        }

        @Override
        public void paintBorder(Component c, Graphics g, int x, int y, int w, int h) {
            Graphics2D g2 = (Graphics2D) g.create();
            g2.setRenderingHint(RenderingHints.KEY_ANTIALIASING,
                               RenderingHints.VALUE_ANTIALIAS_ON);
            g2.drawRoundRect(x, y, w - 1, h - 1, radius, radius);
            g2.dispose();
        }
    }
}
